<%
    console.log("messageList: ",messageList);
%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/static/css/default.css" />
    <link rel="stylesheet" href="/static/css/all.css" />
    <link rel="stylesheet" href="/static/css/swiper.css" />
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="stylesheet" href="/static/css/index.css" />
    <link rel="stylesheet" href="/static/css/responsible.css" />
    <!-- <link rel="stylesheet" href="slick/slick.css" /> -->
    <link rel="stylesheet" href="/static/slick/slick-theme.css" />
    <link rel="stylesheet" href="/static/xeicon/xeicon.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css"> 
	<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script> 
    <!-- <script src="js/jquery-2.2.4.min.js"></script> -->
    <!-- <script src="../js/validate.js"></script> -->
    <script src="/static/js/swiper.min.js"></script>
    <!-- <script src="js/frontEvent.js"></script> -->
    <!-- <script src="/static/slick/slick.js"></script> -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/1.9.0/i18next.min.js" type="text/javascript"></script>
    <script src="/static/js/textFile.js"></script>
</head>
<style>
    /* body{background-color: red;} */
</style>
<body>
    <!-- <div class="modal modal2">
        <div class="costomAlert">
            <h3></h3>
            <div class="btnWrap">
                <button class="closeBtn">확인</button>
            </div>
        </div>
    </div> -->
    <div class="wrap signGage" style="position: relative;">
        <div class="headerWrap">
            <!-- <div class="stepGage">
                <div class="inGage"></div>
            </div> -->
        </div>
        
        <section class="marginCenter signUpWrap mainWrap">
            <div class="tab mainStep block">
                <div class="titleWrap">
                    <h2><span class="ownerNickname">OO</span>님의 새해상</h2>
                    <h3>✉️ 0개의 연하장이 도착했어요!</h3>
                </div>
                <div class="mainImage">
                    <img src="/static/img/mainImage.png" alt="">
                    <!-- 메시지가 생긴 경우 -->
                    <div class="messageContent">
                    <% 
                        for ( var i = 0; i < messageList.length; i++)
                        { 
                    %>
                        <!-- <h4><%=messageList[i].type%></h4> -->
                        <div class="">
                            <img class="imgClass<%-messageList[i].type%>" src="/static/img/i<%-messageList[i].type%>.png" alt="">
                        </div>
                    <% 
                        } 
                    %>
                    </div> 
                    
                </div>
                <div class="pageNum">
                    <a href=""><<</a><span class="currentNum">1</span>/<span class="allNum">1</span><a href="">>></a>
                </div>
                <div class="submitBtn linkCopy invite none">
                    <button onclick="copyUrl()">내 새해상 링크 복사하기</button>
                </div>
                <div class="submitBtn linkCopy beforeInvite none">
                    <button class="decorate">새해상 꾸며주기</button>
                    <button class="create createNewDesk">나도 새해상 만들기</button>
                </div> 
                
            </div>
            <div class="tab choiceStep">
                <div class="stepGage">
                    <div class="inGage"></div>
                </div>
                <div class="titleWrap">
                    <h2>
                        새해상 음식을 
                        <br>골라주세요!
                    </h2>
                </div>
                <div class="foodChoice">
                        <div class="checks">
                            <input type="radio" id="i1" name="food" value="1"> 
                            <label for="i1">
                                <div class="image">
                                    <img src="/static/img/i1.png" alt="">
                                </div>
                                
                            </label> 
                        </div>
                        <div class="checks">
                            <input type="radio" id="i2" name="food" value="2"> 
                            <label for="i2">
                                <div class="image">
                                    <img src="/static/img/i2.png" alt="">
                                </div>
                            </label> 
                        </div>
                        <div class="checks">
                            <input type="radio" id="i3" name="food" value="3"> 
                            <label for="i3">
                                <div class="image">
                                    <img src="/static/img/i3.png" alt="">
                                </div>
                            </label> 
                        </div>
                        <div class="checks">
                            <input type="radio" id="i4" name="food" value="4"> 
                            <label for="i4">
                                <div class="image">
                                    <img src="/static/img/i4.png" alt="">
                                </div>
                            </label> 
                        </div>
                        <div class="checks">
                            <input type="radio" id="i5" name="food" value="5"> 
                            <label for="i5">
                                <div class="image">
                                    <img src="/static/img/i5.png" alt="">
                                </div>
                            </label> 
                        </div>
                        <div class="checks">
                            <input type="radio" id="i6" name="food" value="6"> 
                            <label for="i6">
                                <div class="image">
                                    <img src="/static/img/i6.png" alt="">
                                </div>
                            </label> 
                        </div> 
                    
                </div>
                <div class="submitBtn completeArea">
                    <button class="prev">이전</button>
                    <button class="next">완료</button>
                </div>
            </div>

            <div class="tab writeStep">
                <div class="stepGage active">
                    <div class="inGage"></div>
                </div>
                <div class="titleWrap">
                    <h2>
                        <span class="ownerNickname">OO</span>님에게
                        <br>
                        연하장을 남겨주세요
                    </h2>
                </div>
                <div class="writeForm">
                    <div class="choiced">
                        <img src="" alt="">
                        <!-- <img src="/static/img/i2.png" alt="">
                        <img src="/static/img/i3.png" alt="">
                        <img src="/static/img/i4.png" alt="">
                        <img src="/static/img/i5.png" alt="">
                        <img src="/static/img/i6.png" alt=""> -->
                    </div>
                    <h3>From.</h3>
                    <input type="text" id="nickName" placeholder="닉네임 (최대8자)" maxlength='8'>
                    <textarea name="" id="writeContent" cols="30" rows="10" placeholder="추억에 남는 연하장을 남겨주세요"></textarea>
                </div>
                <div class="publicWrap">
                    <label for="public" class="chk_box">
                        <input type="checkbox" id="public" />
                        <span class="on"></span>
                        연하장 주인에게만 보여줄래요(비공개)
                    </label>
                </div>
                <div class="submitBtn completeArea line">
                    <button class="prev">이전</button>
                    <button class="next">완료</button>
                </div>
            </div>
        </section>
        
    <!-- 모바일 네비게이션 -->
    </div>
    <script>
        let savedToken = localStorage.getItem("accessToken");
        let ownerNickname = "<%=ownerNickname%>";
        let ownerUid = "<%=owner%>";
        let nowUrl = window.location.href;
        function copyUrl(){ 
        //nowUrl 변수에 담긴 주소를
            navigator.clipboard.writeText(nowUrl).then(res=>{
            alert("주소가 복사되었습니다!");
            })
        }

        

        $(function()
        {
            
            // 닉네임 설정
            if(ownerNickname === "")
            {
                $(".ownerNickname").html("익명")
            }
            else
            {
                $(".ownerNickname").html(ownerNickname)
            }
            
            if(savedToken)
            {
                let jsonData = {};
                jsonData.accessToken = savedToken;
                
                $.ajax({
                    type: 'post',
                    url: '/user/verifyToken',
                    data : jsonData,
                    dataType : 'json',
                    success: function(res) {
                        console.log(res);
                        if(res.uid == ownerUid)
                        {
                            console.log("본인의 연하장");
                            $(".invite").removeClass("none");
                        }
                        else
                        {
                            console.log("초대받은 연하장");
                            $(".beforeInvite").removeClass("none");
                            $(".invite").addClass("none");
                            $(".createNewDesk").addClass("none");

                        }
                    },
                    error: function(err) {
                        // localStorage에서 accessToken을 지우고 메인 화면으로 이동
                        localStorage.removeItem('accessToken');
                        location.href = '/';
                    }
                })
            }
            else
            {
                console.log("초대받은 연하장");
                $(".invite").addClass("none");
                $(".beforeInvite").removeClass("none");
                $(".createNewDesk").removeClass("none");
            }


            ///////////////////////////indexSubLink////////////////////////////////
            // 새해상 꾸며주기 버튼 클릭시
            $(".decorate").on("click",function()
                {
                    $(".mainStep").removeClass("block")
                    $(".choiceStep").addClass("block")
                }
            )
            
            // 새해상 음식 선택 클릭
            $(".choiceStep .prev").on("click",function()
                {
                    $(".mainStep").addClass("block")
                    $(".choiceStep").removeClass("block")
                }
            )

            $(".choiceStep .next").on("click",function()
                {
                    $(".choiceStep").removeClass("block")
                    $(".writeStep").addClass("block")
                
                    //선택한 새해 음식 연하장폼에 출력하기
                    if($(".foodChoice .checks input[type='radio']").is(":checked"))
                    {
                        
                        let choicedFood = $(".foodChoice .checks input[type='radio']:checked").val()
                        
                        // $(".mainWrap .writeStep .writeForm .choiced").append('<img class="active" src="/static/img/i'+choicedFood+'.png">')
                        $(".writeForm .choiced img").attr("src", "/static/img/i"+choicedFood+".png").addClass("active")
                    }
                    
                    
                    
                }
            )

            
            
            // 연하장 폼
            $(".writeStep .prev").on("click",function()
                {
                    $(".choiceStep").addClass("block")
                    $(".writeStep").removeClass("block")
                }
            )

            $(".writeStep .next").on("click",function()
                {
                    const URLSearch = new URLSearchParams(location.search);
                    var uidData = URLSearch.get("uid")
                    var foodType = $(".foodChoice .checks input[name='food']:checked").val();
                    var writer = $('.mainWrap .writeStep #nickName').val();
                    var message = $('.mainWrap .writeStep #writeContent').val();
                    var exposure = $('input:checkbox[id=public]').is(':checked');

                    let jsonData2 = {
                        uid:ownerUid,
                        type:foodType,
                        writer,
                        message,
                        exposure,
                    }

                    // console.log(jsonData2)

                    $.ajax({
                            url : "/message",
                            type : "post",
                            data : jsonData2,
                            dataType : 'json',
                            success : function(response){
                                // console.log(res)
                                // if(res === 1)
                                // {
                                //     window.location.href='http://localhost:3000/indexSubLink?uid='+uidData
                                // }

                                // window.location.href=`${base_url}/auth/signUp?uid=${response.uid}`;
                                console.log(response)
                            },
                            error : function(err){
                                console.log(err,"에러")
                            }
                    })
                }
            )
            ///////////////////////////indexSubLink////////////////////////////////
        })
    </script>
</body>
</html>